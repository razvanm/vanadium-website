<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">

  <meta name="viewport"
        content="width=device-width,
                  initial-scale=1,
                  minimum-scale=1,
                  maximum-scale=1,
                  user-scalable=no,
                  minimal-ui">

  <link rel="apple-touch-icon" sizes="57x57" href="https://razvanm.github.io/vanadium-website/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://razvanm.github.io/vanadium-website/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://razvanm.github.io/vanadium-website/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://razvanm.github.io/vanadium-website/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://razvanm.github.io/vanadium-website/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://razvanm.github.io/vanadium-website/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://razvanm.github.io/vanadium-website/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://razvanm.github.io/vanadium-website/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://razvanm.github.io/vanadium-website/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://razvanm.github.io/vanadium-website/favicons/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://razvanm.github.io/vanadium-website/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="https://razvanm.github.io/vanadium-website/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="160x160" href="https://razvanm.github.io/vanadium-website/favicons/favicon-160x160.png">
  <link rel="icon" type="image/png" sizes="192x192" href="https://razvanm.github.io/vanadium-website/favicons/favicon-192x192.png">
  <meta name="msapplication-TileColor" content="#00acc1">
  <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">

  <link href="https://fonts.googleapis.com/css?family=Material+Icons&display=block" rel="stylesheet">
  <link rel="stylesheet" href="https://razvanm.github.io/vanadium-website/bundle.css"/>
</head>
<body>

<div class="w-full fixed top-0">
  <div class="bg-background-svg bg-no-repeat [background-size:100%] py-[16px] px-[12px] flex flex-row">
    <a href="https://razvanm.github.io/vanadium-website/">
      <img src="https://razvanm.github.io/vanadium-website/images/v-icon-white.svg"/>
    </a>

    <div class="text-white pl-[20px] text-[20px] font-medium">
      Vanadium Core
    </div>

    <div class="grow"></div>

    <a href="https://github.com/" class="fill-white">
      <svg viewBox="0 0 16 16" class="w-[32px]">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
      </svg>
    </a>
  </div>
</div><div class="fixed top-[64px] left-0 w-[200px] z-10 h-[calc(100%-64px)] bg-gray-50">
  <nav class="overflow-y-auto h-full py-4 pl-4 leading-[20px] text-[14px]">
    <a href="https://razvanm.github.io/vanadium-website/overview">Overview</a>
    <a href="https://razvanm.github.io/vanadium-website/installation">Installation</a>
    <div>Tutorials</div>
    <nav class="pl-3">
      <a href="https://razvanm.github.io/vanadium-website/tutorials/hello-world">Hello World</a>
      <a href="https://razvanm.github.io/vanadium-website/tutorials/basics">Client/Server Basics</a>

      <div>Security</div>
      <nav class="pl-3">
        <a href="https://razvanm.github.io/vanadium-website/tutorials/security">Overview</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/security/principals-and-blessings">Principal and Blessings</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/security/permissions-authorizer">Permissions Authorizer</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/security/first-party-caveats">Caveats</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/security/third-party-caveats">Third-party Caveats</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/security/agent">The Agent</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/security/custom-authorizer">Customer Authorizer</a>
      </nav>

      <div>Naming</div>
      <nav class="pl-3">
        <a href="https://razvanm.github.io/vanadium-website/tutorials/naming">Overview</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/naming/mount-table">The Mount Table</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/naming/namespace">Namespaces</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/naming/suffix-part1">The Suffix - Part I</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/naming/suffix-part2">The Suffix - Part II</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/naming/globber">Globber</a>
      </nav>

      <div>Java</div>
      <nav class="pl-3">
        <a href="https://razvanm.github.io/vanadium-website/tutorials/java">Overview</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/java/fortune">Fortune in Java</a>
        <a href="https://razvanm.github.io/vanadium-website/tutorials/java/android">Location Service in Android</a>
      </nav>

      <a href="https://razvanm.github.io/vanadium-website/tutorials/faq">Tutorial FAQ</a>
    </nav>

    <div>Concepts</div>
    <nav class="pl-3">
      <a href="https://razvanm.github.io/vanadium-website/concepts/rpc">RPC System</a>
      <a href="https://razvanm.github.io/vanadium-website/concepts/naming">Naming</a>
      <a href="https://razvanm.github.io/vanadium-website/concepts/security">Security</a>
      <a href="https://razvanm.github.io/vanadium-website/concepts/device-management">Device Management</a>
    </nav>

    <div>Design Docs</div>
    <nav class="pl-3">
      <a href="https://razvanm.github.io/vanadium-website/designdocs/authentication">Authentication Protocol</a>
      <a href="https://razvanm.github.io/vanadium-website/designdocs/identity-service">Identity Service</a>
      <a href="https://razvanm.github.io/vanadium-website/designdocs/vdl-spec">VDL Specification</a>
      <a href="https://razvanm.github.io/vanadium-website/designdocs/vom-spec">VOM Specification</a>
    </nav>

    <a href="https://razvanm.github.io/vanadium-website/api-reference">API Reference</a>
    <a href="https://razvanm.github.io/vanadium-website/glossary">Glossary</a>
    <a href="https://razvanm.github.io/vanadium-website/faq">FAQ</a>

    <div>Community</div>
    <nav class="pl-3">
      <a href="https://razvanm.github.io/vanadium-website/community/coding-guidelines">Coding Guidelines</a>
      <a href="https://razvanm.github.io/vanadium-website/community/contributing">Contributing</a>
      <a href="https://razvanm.github.io/vanadium-website/community/mailing-lists">Mailing List</a>
      <a href="https://razvanm.github.io/vanadium-website/community/roadmap">Roadmap</a>
    </nav>
  </nav>
</div>

  <div class="hidden xl:block fixed top-[64px] right-0 w-[200px] p-4 text-[14px] border-l-4 border-l-gray-100 h-[calc(100%-64px)]">
    <div class="uppercase font-medium pb-3">Identity Service</div>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#preliminaries">Preliminaries</a></li>
    <li><a href="#service-interfaces">Service interfaces</a></li>
    <li><a href="#user-blessing-flow">User-Blessing flow</a></li>
    <li><a href="#application-blessing-flow">Application-Blessing flow</a></li>
    <li><a href="#supported-caveats">Supported caveats</a>
      <ul>
        <li><a href="#revocation">Revocation</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>

<div class="flex flex-col h-screen pt-[64px]">
  <div class="ml-[200px] px-11 w-[800px]">
    <h1 class="text-primary-color text-[48px]">Identity Service</h1>

    
<content>
      <p>The <a href="https://github.com/vanadium/go.ref/tree/master/services/identity/identityd">Vanadium Identity Service</a> generates <a href="https://razvanm.github.io/vanadium-website/2016/glossary.html#blessing">blessings</a>.
It uses an <a href="http://oauth.net/2/">OAuth2</a> identity provider to get the email address of the user on
whose behalf the request is made and then issues a blessing for that email
address. Blessings issued by this service are of two kinds:</p>
<ul>
<li><strong>User-Blessing</strong>: A user-blessing authorizes the (blessed) principal to act on
behalf of the user. The blessing is  namespaced under the user&rsquo;s email address
and is of the form <code>dev.v.io:u:&lt;email&gt;</code> (where <code>dev.v.io</code> is
the namespace for which the public key of the identity service is considered
authoritative on). For example, if <code>alice@university.edu</code> is the email
address obtained for the user (using OAuth2) then the issued blessing has the name
<code>dev.v.io:u:alice@university.edu</code>. These blessings are very powerful as they
allow the principal to act on behalf of the user while making requests to any
service. Thus the flow for obtaining these blessings involves selecting caveats
that must be placed on the blessing in order to limit its scope.</li>
<li><strong>Application-Blessing</strong>: An app blessing authorizes the (blessed) principal to act on
behalf of the user in the context of a specific application. The blessing is
namespaced under the application identified in the request, and is of the form
<code>dev.v.io:o:&lt;appid&gt;:&lt;email&gt;</code>. The
application identifier and email address are obtained using OAuth2. Specifically,
the applicaiton identifier is the <code>audience</code> field in the token&rsquo;s
decription. For example, if  <code>alice@university.edu</code> is the email
address obtained for the user and <code>xyz123</code> is an identifier for the requesting
application then the issued blessing has the name <code>dev.v.io:o:xyz123:alice@university.edu</code>.
An application-blessing is relatively less priveleged than a user-blessing as it
does not allow the principal to arbitrarily act on behalf of the user.</li>
</ul>
<p>Broadly, the identity service has three main components:</p>
<ul>
<li><strong>HTTPS Authentication Service</strong>: Authenticates the user using
an OAuth2 Identity Provider, and securely hands out a token (henceforth
called a macaroon) that encapsulates the user&rsquo;s authenticated identity and
any caveats that the user may have requested to be added to the blessing. The
cryptographic construction of macaroons ensures that their contents cannot be
tampered with.</li>
<li><strong>Vanadium User-Blessing Service</strong>: Exchanges the macaroon for a user-blessing
via a Vanadium RPC. The blessing is bound to the principal invoking the RPC
and has the name and caveats specified in the presented macaroon.</li>
<li><strong>HTTPS Application-Blessing Service</strong>: Exchanges an OAuth2 token
and a public key for an application-blessing for the provided public key.
The email address and application identifier specified in the blessing are
determined using the provided OAuth2 token.</li>
</ul>
<p>One additional service enables revocation of the granted blessings:</p>
<ul>
<li><strong>Vanadium Discharge Service</strong>: Issues <a href="https://razvanm.github.io/vanadium-website/2016/glossary.html#discharge">discharges</a> for a revocation
<a href="https://razvanm.github.io/vanadium-website/2016/glossary.html#caveat">caveat</a> if the blessing has not been revoked by the user. The discharges are
valid for 15 minutes.</li>
</ul>
<p>All services are exposed by a single binary - <a href="https://github.com/vanadium/go.ref/tree/master/services/identity/identityd"><code>identityd</code></a>.  Since
user-blessings are quite powerful, it is important to limit their scope
using caveats. This complicates the flow for obtaining these blessings
and involves a sequence of interactions with the authentication service
and the Vanadium blessing service. In order to save users from interacting
with multiple services and exchanging credentials betweeen them, we also
provide a command-line tool - <a href="https://github.com/vanadium/go.ref/tree/master/cmd/principal"><code>principal</code></a> - that carries out the work of
communicating with the services and obtaining a user-blessing for the
principal that the tool is running as.</p>
<h1 id="preliminaries">Preliminaries</h1>
<p>Before diving into the details of <a href="https://github.com/vanadium/go.ref/tree/master/services/identity/identityd"><code>identityd</code></a>&rsquo;s design, some prerequisites:</p>
<ul>
<li><a href="https://razvanm.github.io/vanadium-website/concepts/security.html">Principals, Blessings and Caveats</a>.</li>
<li>Third-party caveats: In a nutshell, a third-party caveat is a restriction on
the use of a blessing that must be validated by a party other than the two
communicating with and authorizing each other. The <a href="https://razvanm.github.io/vanadium-website/2016/glossary.html#blessing">blessing</a> with a
third-party caveat is considered valid only if accompanied by a <a href="https://razvanm.github.io/vanadium-website/2016/glossary.html#discharge">discharge</a>
issued by the third party that validated the restrictions. Discharges are
unforgeable and cryptographically bound to the correpsonding third-party
caveat.</li>
<li><em>Macaroons</em>: For the purposes of the identity service, a macaroon is a bearer
token, similar to a cookie that can only be minted (and verified) by the
identity service. A macaroon encapsulates state whose bits cannot be tampered
with by anyone but the identity service. The state itself though is visible
to the bearers of the macaroon. In particular, the identity service with a
secret <a href="http://en.wikipedia.org/wiki/Hash-based_message_authentication_code">HMAC</a> key <code>k</code> defines a macaroon for a state as:
<code>Macaroon<sub>k</sub>(state) = HMAC(k, state)</code>
The name &ldquo;cookie&rdquo; or &ldquo;token&rdquo; could have been used instead, but the term
macaroon was an allusion to <a href="http://research.google.com/pubs/archive/41892.pdf">this
paper</a>.</li>
</ul>
<h1 id="service-interfaces">Service interfaces</h1>
<p>The HTTPS Authentication Service runs at <a href="https://dev.v.io/auth">https://dev.v.io/auth</a> and uses the
Google OAuth2 <a href="https://developers.google.com/accounts/docs/OAuth2WebServer">web service flow</a> for authenticating users.  It has a specific
OAuth2 ClientID and ClientSecret obtained from the Google Developer Console. It
supports the following routes:</p>
<table>
<thead>
<tr>
<th>Route</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/google/seekblessings</code></td>
<td>Receive user-blessing requests</td>
</tr>
<tr>
<td><code>/google/caveats</code></td>
<td>Display a form for selecting caveats to be added to a blessing</td>
</tr>
<tr>
<td><code>/google/sendmacaroon</code></td>
<td>Receive a POST request from the caveat selection form</td>
</tr>
<tr>
<td><code>/google/listblessings</code></td>
<td>Enumerate all blessings made by a particular user</td>
</tr>
<tr>
<td><code>/google/revoke</code></td>
<td>Receive revocation requests</td>
</tr>
<tr>
<td><code>/google/bless</code></td>
<td>Receive application-blessing requests</td>
</tr>
</tbody>
</table>
<p>The blessing service is a Vanadium RPC service reachable via the name
<code>/ns.dev.v.io:8101/identity/dev.v.io/u/google</code> and presents the <a href="https://github.com/vanadium/go.ref/blob/master/services/identity/identity.vdl"><code>MacaroonBlesser</code></a> interface:</p>
<pre tabindex="0"><code>type MacaroonBlesser interface {
  // Bless uses the provided macaroon (which contains email and caveats)
  // to return a blessing for the client.
  Bless(macaroon string) (blessing security.WireBlessings | error)
}
</code></pre><h1 id="user-blessing-flow">User-Blessing flow</h1>
<p>The <a href="https://github.com/vanadium/go.ref/tree/master/cmd/principal"><code>principal</code></a> command-line tool is used to orchestrate the process of
obtaining a macaroon from the HTTPS Authentication Service and exchanging it
for a user-blessing from the Vanadium Blessing Service. The following sequence
diagram lists the network requests involved in this process:</p>
<p><img src="https://razvanm.github.io/vanadium-website/2016/images/blessing-flow.svg" alt="Blessing flow diagram"></p>
<ul>
<li>Solid-line arrows represent HTTPS requests (except one HTTP to localhost).</li>
<li>Dotted-line arrows represent Vanadium RPC requests.</li>
</ul>
<p>Steps 1 through  4 in the sequence diagram above result in the <a href="https://github.com/vanadium/go.ref/tree/master/cmd/principal"><code>principal</code></a> tool
invocation obtaining a macaroon.</p>
<p>Steps 5 and 6 exchange that macaroon for a user-blessing.</p>
<ol>
<li>
<p>The tool generates a random state parameter <code>toolState</code> and starts an HTTP
server on <code>localhost</code> for receiving the macaroon. <code>toolURI</code> denotes the URI
of this server (e.g., <code>http://127.0.0.1:14141</code>), and <code>toolPublicKey</code> denotes
the public key of the principal running the tool.
It then directs the web browser on the machine to the HTTP Authentication
Service while informing it of <code>toolURI</code>, <code>toolPublicKey</code> and the <code>toolState</code>
parameters. For example, it might redirect to:
<code>https://dev.v.io/auth/google/seekblessings?redirect_uri=&lt;toolURI&gt;&amp;state=&lt;toolState&gt;&amp;public_key=&lt;toolPublicKey&gt;</code></p>
</li>
<li>
<p>The HTTP Authentication Service extracts <code>toolURI</code>, <code>toolState</code> and
<code>toolPublicKey</code> and redirects the browser to the Google OAuth2 endpoint
(using the <a href="https://developers.google.com/accounts/docs/OAuth2WebServer">web service flow</a>). The <code>redirect_uri</code> provided to this endpoint
is set to the page that presents a form to control caveats on the final
blessing and the <code>state</code> parameter is set to: <code>oauthstate = Macaroon<sub>k</sub>(toolURI +
toolState + toolPublicKey + serverCookie)</code> where <code>serverCookie</code> is a
cookie set by the HTTP Authentication Service in the user&rsquo;s browser. This leads
the user&rsquo;s browser to a URL like:
<code>https://accounts.google.com/o/oauth2/auth?client_id=...&amp;redirect_uri=https://dev.v.io/auth/google/caveat&amp;state=oauthstate</code></p>
<p>The Google OAuth2 endpoint asks the user to login and grant access to email
address to the Vanadium Identity Server, after which it redirect the browser
back to:
<code>https://dev.v.io/auth/google/caveats?code=&lt;authcode&gt;&amp;state=&lt;oauthstate&gt;</code></p>
</li>
<li>
<p>The caveats page at the HTTP Authentication Service receives <code>authcode</code> and
<code>oauthstate</code>. It then:</p>
<ul>
<li>Verifies that <code>oauthstate</code> is a valid macaroon generated by step 2.</li>
<li>Extracts <code>toolURI</code>, <code>toolState</code>, <code>toolPublicKey</code> and <code>serverCookie</code> from the macaroon.</li>
<li>Verifies that <code>serverCookie</code> matches the cookie presented by the browser</li>
<li>Exchanges <code>authcode</code> for an email address (via an identity token) using
the OAuth2 client-secret.</li>
<li>Displays a form for selecting caveats to be added to the blessing that
will ultimately be provided to the <a href="https://github.com/vanadium/go.ref/tree/master/cmd/principal"><code>principal</code></a> tool started in step 1.
Embedded in this form is <code>formstate = Macaroon&lt;sub&gt;k&lt;/sub&gt;(toolURI + toolState + toolPublicKey + email + serverCookie)</code>.</li>
</ul>
</li>
<li>
<p>When the user submits the form rendered in step 3, the browser sends the form
contents to <code>https://dev.v.io/auth/google/sendmacaroon</code> which performs the
following steps:</p>
<ul>
<li>Verifies that <code>formstate</code> is a valid macaroon.</li>
<li>Extracts <code>toolURI</code>, <code>toolState</code>, <code>toolPublicKey</code>, <code>email</code> and <code>serverCookie</code> encapsulated
in the macaroon.</li>
<li>Verifies that <code>serverCookie</code> matches the cookie presented by the browser.</li>
<li>Verifies that <code>toolURI</code> is a localhost URI.</li>
<li>Computes <code>M = Macaroon<sub>k</sub>(email, toolPublicKey, caveats)</code>.</li>
<li>Redirects the browser to:
<code>https://&lt;toolURI&gt;/macaroon?state=&lt;toolState&gt;&amp;macaroon=M&amp;root_key=publicKey</code>
where <code>publicKey</code> is the <a href="https://razvanm.github.io/vanadium-website/2016/glossary.html#blessing-root">blessing root</a> of the identity service.</li>
</ul>
</li>
<li>
<p>The <code>principal</code> tool receives the macaroon <code>M</code>, <code>toolState</code> and the
<a href="https://razvanm.github.io/vanadium-website/2016/glossary.html#blessing-root">blessing root</a> via the HTTP redirect in step 4. It then:</p>
<ul>
<li>Verifies that <code>toolState</code> obtained here matches the one created in step 1.</li>
<li>Invokes the <code>Bless</code> RPC on the blessing service passing it <code>M</code> as an argument.
It only sends this request if the the RPC server proves that it&rsquo;s public key
is <code>publicKey</code> via the <a href="https://razvanm.github.io/vanadium-website/2016/designdocs/authentication.html">authentication protocol</a> used in RPCs.</li>
</ul>
</li>
<li>
<p>The Vanadium Blessing Service that receives this RPC performs the following steps:</p>
<ul>
<li>Verifies that the macaroon presented is valid.</li>
<li>Extracts <code>email</code>, <code>toolPublicKey</code> and <code>caveats</code> from it.</li>
<li>Verifies that the principal making the RPC request has the same public key
as <code>toolPublicKey</code>. This check ensures that the macaroon can only be used by
the principal tool that requested it in the first place. It protects against
impersonation attacks wherein an attacker steals the macaroon handed out in
step 5 and then tries to obtain a blessing for the email address encapsulated
in the macaroon.</li>
<li>Generates a user-blessing with the name <code>dev.v.io:u:&lt;email&gt;</code> and the
caveats extracted from the macaroon. This blessing is bound to the public
key of the principal making the RPC request (i.e., <code>toolPublicKey</code>).</li>
<li>Records the creation of this blessing in a database which can be queried via
<code>https://dev.v.io/auth/google/listblessings</code>.</li>
</ul>
</li>
</ol>
<h1 id="application-blessing-flow">Application-Blessing flow</h1>
<p>Any application that possesses an OAuth2 token can make
a request for an application-blessing. Such a request is made via GET request to
the HTTPS Application-Blessing Service. The request must include the following
parameters:</p>
<ul>
<li><code>public_key</code>: Base64URL DER encoded PKIX representation of the public key to
be blessed.</li>
<li><code>token</code>: Google OAuth2 access token</li>
<li><code>caveats</code>: Base64URL VOM encoded list of caveats. This parameter is optional.</li>
<li><code>output_format</code>: The encoding format for the returned blessings. The following
formats are supported:
<ul>
<li><code>base64vom</code>: Base64URL encoding of VOM-encoded blessings [Default]</li>
<li><code>json</code>: JSON-encoded blessings.</li>
</ul>
</li>
</ul>
<p>For example, the request URL may be:
<code>https://dev.v.io/auth/google/bless?public_key=&lt;publicKey&gt;&amp;token=&lt;token&gt;</code></p>
<p>The token provided must be a Google OAuth2 access token but may be bound to any
OAuth2 Client ID. The Vanadium identity service may not have a pre-existing
relationship with the application that the ClientID has been registered for.</p>
<p>When the service receives a request for an application-blessing, its presents the
provided token to Google&rsquo;s <a href="https://developers.google.com/identity/protocols/OAuth2UserAgent#validatetoken"><code>tokeninfo</code></a> endpoint, and among other things,
obtains the email address and the ClientID that the token is bound to. (In particular,
the ClientID is obtained from the <code>aud</code> field of the <a href="https://developers.google.com/identity/protocols/OAuth2UserAgent#validatetoken"><code>tokeninfo</code></a> struct.)
The service then generates an application-blessing for the provided public key. By
default, the application identifier is set to the ClientID obtained from the access
token. In some cases, the application corresponding to the ClientID may have
<a href="https://vanadium-review.googlesource.com/#/c/19913/">registered</a>
a specific name with the Vanadium identity service, in which case, that name is used
as the application identifier. The generated blessing carries any caveats provided
during the request.</p>
<h1 id="supported-caveats">Supported caveats</h1>
<p>The caveat addition form presented to the user in step 4 supports a few types
of caveats:</p>
<ul>
<li><a href="https://github.com/vanadium/go.v23/blob/master/security/caveat.vdl"><em>Expiry</em></a>: Which limits the time period during which the blessing is valid.</li>
<li><a href="https://github.com/vanadium/go.v23/blob/master/security/caveat.vdl"><em>PeerBlessings</em></a>: Which limits the set of peers that the blessing will be recognized by.</li>
<li><a href="https://github.com/vanadium/go.v23/blob/master/security/caveat.vdl"><em>Method</em></a>: Which limits the set of methods that can be invoked with the blessing.</li>
<li><a href="https://github.com/vanadium/go.ref/tree/master/services/identity/internal/revocation"><em>Revocation</em></a>: Which allows the user to revoke the blessing at any time in
the future by visiting <a href="https://dev.v.io/auth/google/listblessings">https://dev.v.io/auth/google/listblessings</a>.</li>
</ul>
<h2 id="revocation">Revocation</h2>
<p>The revocation caveat that is (at the user&rsquo;s request) added to the blessing is
a third-party caveat with a unique 16-byte ID and the object name of the
discharging service. Each time a revocation caveat is created, the blessing
service stores the corresponding ID and the revocation status in a SQL
database.</p>
<p>The <a href="https://github.com/vanadium/go.ref/blob/master/services/discharger/discharger.vdl">discharge service</a> run by <a href="https://github.com/vanadium/go.ref/tree/master/services/identity/identityd"><code>identityd</code></a> extracts the ID from the caveat
and looks it up in the database. If the database suggests that blessing should
be revoked, it refuses to issue a discharge.</p>
<p>This is implemented in
<a href="https://github.com/vanadium/go.ref/tree/master/services/identity/internal/revocation">services/identity/internal/revocation</a>.</p>
<p>Revocation can be triggered by clicking buttons on <a href="https://dev.v.io/auth/google/listblessings">https://dev.v.io/auth/google/listblessings</a>.</p>

    </content>
 </div>

 <nav class="flex flex-wrap-reverse mt-6 ml-[200px] z-[1]">
  

  
</nav>

  
</div>

</body>
</html>
