<!DOCTYPE html>
<html><head>
  <meta charset="utf-8">

  <meta name="viewport"
        content="width=device-width,
                  initial-scale=1,
                  minimum-scale=1,
                  maximum-scale=1,
                  user-scalable=no,
                  minimal-ui">

  <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
  <meta name="msapplication-TileColor" content="#00acc1">
  <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">

  <link href="https://fonts.googleapis.com/css?family=Material+Icons&display=block" rel="stylesheet">
  <link rel="stylesheet" href="/bundle.css"/>
</head>
<body>

<div class="w-full fixed top-0">
  <div class="bg-[url('/images/background.svg')] bg-no-repeat [background-size:100%] py-[16px] px-[12px] flex flex-row">
    <a href="/">
      <img src="/images/v-icon-white.svg"/>
    </a>

    <div class="text-white pl-[20px] text-[20px] font-medium">
      Vanadium Core
    </div>

    <div class="grow"></div>

    <a href="https://github.com/" class="fill-white">
      <svg viewBox="0 0 16 16" class="w-[32px]">
        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
      </svg>
    </a>
  </div>
</div><div class="fixed top-[64px] left-0 w-[200px] z-10 h-[calc(100%-64px)] bg-gray-50">
  <nav class="overflow-y-auto h-full py-4 pl-4 leading-[20px] text-[14px]">
    <a href="/overview">Overview</a>
    <a href="/installation">Installation</a>
    <div>Tutorials</div>
    <nav class="pl-3">
      <a href="/tutorials/hello-world">Hello World</a>
      <a href="/tutorials/basics">Client/Server Basics</a>

      <div>Security</div>
      <nav class="pl-3">
        <a href="/tutorials/security">Overview</a>
        <a href="/tutorials/security/principals-and-blessings">Principal and Blessings</a>
        <a href="/tutorials/security/permissions-authorizer">Permissions Authorizer</a>
        <a href="/tutorials/security/first-party-caveats">Caveats</a>
        <a href="/tutorials/security/third-party-caveats">Third-party Caveats</a>
        <a href="/tutorials/security/agent">The Agent</a>
        <a href="/tutorials/security/custom-authorizer">Customer Authorizer</a>
      </nav>

      <div>Naming</div>
      <nav class="pl-3">
        <a href="/tutorials/naming">Overview</a>
        <a href="/tutorials/naming/mount-table">The Mount Table</a>
        <a href="/tutorials/naming/namespace">Namespaces</a>
        <a href="/tutorials/naming/suffix-part1">The Suffix - Part I</a>
        <a href="/tutorials/naming/suffix-part2">The Suffix - Part II</a>
        <a href="/tutorials/naming/globber">Globber</a>
      </nav>

      <div>Java</div>
      <nav class="pl-3">
        <a href="/tutorials/java">Overview</a>
        <a href="/tutorials/java/fortune">Fortune in Java</a>
        <a href="/tutorials/java/android">Location Service in Android</a>
      </nav>

      <a href="/tutorials/faq">Tutorial FAQ</a>
    </nav>

    <div>Concepts</div>
    <nav class="pl-3">
      <a href="/concepts/rpc">RPC System</a>
      <a href="/concepts/naming">Naming</a>
      <a href="/concepts/security">Security</a>
      <a href="/concepts/device-management">Device Management</a>
    </nav>

    <div>Design Docs</div>
    <nav class="pl-3">
      <a href="/designdocs/authentication">Authentication Protocol</a>
      <a href="/designdocs/identity-service">Identity Service</a>
      <a href="/designdocs/vdl-spec">VDL Specification</a>
      <a href="/designdocs/vom-spec">VOM Specification</a>
    </nav>

    <a href="/api-reference">API Reference</a>
    <a href="/glossary">Glossary</a>
    <a href="/faq">FAQ</a>

    <div>Community</div>
    <nav class="pl-3">
      <a href="/community/coding-guidelines">Coding Guidelines</a>
      <a href="/community/contributing">Contributing</a>
      <a href="/community/mailing-lists">Mailing List</a>
      <a href="/community/roadmap">Roadmap</a>
    </nav>
  </nav>
</div>

  <div class="hidden xl:block fixed top-[64px] right-0 w-[200px] p-4 text-[14px] border-l-4 border-l-gray-100 h-[calc(100%-64px)]">
    <div class="uppercase font-medium pb-3">Custom Authorizer</div>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#custom-authorization-policy">Custom authorization policy</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
  </div>

<div class="flex flex-col h-screen pt-[64px]">
  <div class="ml-[200px] px-11 w-[800px]">
    <h1 class="text-primary-color text-[48px]">Custom Authorizer</h1>

    
    <p><strong>Wherein</strong> you craft a custom authorizer for Alice that lets family in at any time, but constrains friends to a time window.  This is an advanced tutorial.</p>
    
  <div class="my-8 -mx-4 px-4 border border-blue-grey-50/100 rounded">
    <p>
      <strong>Prerequisites</strong>:<br>
      All tutorials require Vanadium <a href="/installation/">installation</a>,
      and must run in a <a href="/tutorials/faq.html#why-bash-">bash shell</a>.
    </p>

    
      <p>
        Further, please
        <a href="/sh/scenario-d-setup.sh"
           download="scenario-d-setup.sh">
           download this script
        </a>
        then <a href="/tutorials/faq.html#why-source-">source</a> it:
      </p>

      <pre><code>source ~/Downloads/scenario-d-setup.sh</code></pre>

      <p>
        This command wipes tutorial files and defines shell environment
        variables. If you start a new terminal, and just want to re-establish
        the environment, see instructions
        <a href="/tutorials/setup.html">here</a>.
      </p>
    

    
      <p>
        If you would like to generate files from this tutorial without the
        copy/paste steps, download and source
        <a href="/sh/tut-completer-custom-authorizer.sh"
            download="tut-completer-custom-authorizer.sh">
            this script
        </a>.
        Files will be created in the <code>$V_TUT</code>
        <a href="/tutorials/setup.html">directory</a>.
      </p>
    
  </div>

<content>
      <h1 id="introduction">Introduction</h1>
<p>The goal of this tutorial is to make a custom authorizer
and test it using some existing principals.</p>
<p>This command</p>
<pre tabindex="0"><code>ls $V_TUT/cred
</code></pre><p>should list (at least) <code>alice</code> and <code>bob</code> and <code>carol</code>.</p>
<p>The prerequisite script should have arranged for Bob to have the
blessing <code>alice:friend:bob</code> and Carol to have the blessing
<code>alice:family:sister</code>.</p>
<h1 id="custom-authorization-policy">Custom authorization policy</h1>
<p>If the <a href="/2016/tutorials/security/permissions-authorizer.html">Permissions authorizer</a> and/or caveats (caveats
are discussed <a href="/2016/tutorials/security/first-party-caveats.html">later</a>) aren&rsquo;t sufficient for some purpose,
Vanadium applications can create their own arbitrarily complex policy by
implementing the <a href="https://vanadium.googlesource.com/release.go.v23/+/master/security/model.go#465"><code>security.Authorizer</code></a> interface.</p>
<p>For example, this policy:</p>
<blockquote>
<p><em>Alice&rsquo;s family can access the service at any time,
but friends can access only during a particular time window.</em></p>
</blockquote>
<p>is implemented by this code:</p>
<!-- @authorizerWithFriendWindow @test @completer -->
<pre tabindex="0"><code> cat - &lt;&lt;EOF &gt;$V_TUT/src/fortune/server/util/authorizer.go
package util

import (
  &quot;flag&quot;
  &quot;fmt&quot;
  &quot;time&quot;
  &quot;v.io/v23/context&quot;
  &quot;v.io/v23/security&quot;
)

var (
  openStart  = flag.Int(
    &quot;start&quot;, 12, &quot;Hour when friends may start access.&quot;)
  openLength = flag.Int(
    &quot;length&quot;, 1, &quot;Number of hours the window stays open.&quot;)
)

type policy struct{}

func (policy) Authorize(ctx *context.T, call security.Call) error {
  var (
    client, _  = security.RemoteBlessingNames(ctx, call)
    hour, _, _ = time.Now().Clock()
    friendsOk  = hour &gt;= *openStart &amp;&amp;
                 hour &lt; (*openStart + *openLength)

    // Patterns on the blessings of authorized folks.
    friends = security.BlessingPattern(&quot;alice:friend&quot;)
    family  = security.BlessingPattern(&quot;alice:family&quot;)
  )
  // The client may present multiple blessings, check if any
  // of them satisfy the policy.
  if family.MatchedBy(client...) {
      // family is always okay, so this request is authorized.
      return nil
  }
  if friends.MatchedBy(client...) {
    // Friends only allowed in a given time window.
    if friendsOk {
      return nil
    }
    return fmt.Errorf(
        &quot;friends like %v not authorized at this hour (%d)&quot;,
        client, hour)
  }
  // Nobody else is authorized
  return fmt.Errorf(&quot;not friend nor family, not authorized&quot;)
}

func MakeAuthorizer() security.Authorizer {
  return policy{}
}
EOF
go install fortune/server
</code></pre><p>Kill the running server (if any) and restart it so that it picks up this
new authorization policy:</p>
<!-- @serverAsAliceWithFriendWindow @test @sleep -->
<pre tabindex="0"><code>kill_tut_process TUT_PID_SERVER
$V_TUT/bin/server \
    --v23.credentials $V_TUT/cred/alice \
    --endpoint-file-name $V_TUT/server.txt \
    --start `date +%k` &amp;
TUT_PID_SERVER=$!
</code></pre><p>Bob has the blessing <code>alice:friend:bob</code>, so RPCs will succeed - but
only in the given time window.</p>
<p>The following should work since <code>--start</code> is set
to the current hour:</p>
<!-- @clientAsBob @test -->
<pre tabindex="0"><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/bob \
    --server `cat $V_TUT/server.txt`
</code></pre><p><img src="/2016/images/tut/security10-bob-succeeds-biz-hours.svg" alt="Bob&rsquo;s request to the server succeeds because it is during business hours"></p>
<p>Restart the server with a value of <code>--start</code> a few hours
in the future so that Bob&rsquo;s requests are rejected:</p>
<!-- @serverRejectingBob -->
<pre tabindex="0"><code>kill_tut_process TUT_PID_SERVER
$V_TUT/bin/server \
    --v23.credentials $V_TUT/cred/alice \
    --endpoint-file-name $V_TUT/server.txt \
    --start `expr \`date +%k\` + 3` &amp;
TUT_PID_SERVER=$!
</code></pre><p>Bob is now rejected:</p>
<!-- @bobIsRejected -->
<pre tabindex="0"><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/bob \
    --server `cat $V_TUT/server.txt`
</code></pre><p><img src="/2016/images/tut/security11-bob-fails-biz-hours.svg" alt="Bob&rsquo;s request to the server fails because it is outside of business hours"></p>
<p>Carol, on the other hand, has the blessing <code>alice:family:sister</code>.</p>
<p>Bob may be locked out, but Carol&rsquo;s requests work regardless of
the time:</p>
<!-- @clientAsCarol @test -->
<pre tabindex="0"><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/carol \
    --server `cat $V_TUT/server.txt`
</code></pre><p>Feel free to review Carol&rsquo;s status with the <a href="/2016/tutorials/security/principals-and-blessings.html#principal-dump"><code>principal dump</code></a> command.</p>
<p><img src="/2016/images/tut/security12-alice-carol-succeed.svg" alt="Carol&rsquo;s request to the server succeeds"></p>
<p>We&rsquo;re done with the server for now.</p>
<!-- @killServer @test -->
<pre tabindex="0"><code>kill_tut_process TUT_PID_SERVER
</code></pre><h1 id="summary">Summary</h1>
<ul>
<li>
<p>A custom authorization policy allowed Alice to provide different
access to friends and family.</p>
</li>
<li>
<p>Alice can bless anyone as friend or family to give them access
without modifying her server.</p>
</li>
</ul>

    </content>
 </div>

 <nav class="flex flex-wrap-reverse mt-6 ml-[200px] z-[1]">
  
    
      <a href="/tutorials/security/agent/" class="p-8 flex justify-start items-center bg-cyan-800 grow">
        <div class="flex items-center justify-center w-[48px] h-[48px]">
          <i class="material-icons text-white">arrow_back</i>
        </div>
        <div class="flex flex-col items-start">
          <div class="text-white/70 text-xs">Previous</div>
          <div class="text-white">The Agent</div>
        </div>
      </a>
    
  

  
</nav>

  
</div>

</body>
</html>
